# ì•„í‚¤í…ì²˜ ê°œìš”

ì´ ë¬¸ì„œëŠ” IaaS í”Œëž«í¼ì˜ ê¸°ìˆ  ìŠ¤íƒ, í˜„ìž¬ ì•„í‚¤í…ì²˜ ë° í–¥í›„ ë°œì „ ë°©í–¥ì— ëŒ€í•´ ì„¤ëª…í•©ë‹ˆë‹¤.

## 1. í•µì‹¬ ê¸°ìˆ  ìŠ¤íƒ

- **ì–¸ì–´**: Python 3
- **ë°±ì—”ë“œ**: ìˆœìˆ˜ WSGI
- **ë°ì´í„°ë² ì´ìŠ¤**: SQLite (SQLAlchemy ORM ì‚¬ìš©)
- **ê°€ìƒí™”**: KVM/QEMU ë° libvirt-python
- **ê°œë°œ í™˜ê²½**: Vagrantì™€ VirtualBox (ì¤‘ì²© ê°€ìƒí™”)

## 2. ê³„ì¸µí˜• ì•„í‚¤í…ì²˜ (Layered Architecture)

í˜„ìž¬ í”„ë¡œì íŠ¸ëŠ” ìœ ì§€ë³´ìˆ˜ì„±ê³¼ í™•ìž¥ì„±ì„ ê·¹ëŒ€í™”í•˜ê¸° ìœ„í•´ ëª…í™•í•œ ê³„ì¸µí˜• ì•„í‚¤í…ì²˜ë¥¼ ë”°ë¦…ë‹ˆë‹¤. ê° ê³„ì¸µì€ ì§€ì •ëœ ì—­í• ë§Œ ìˆ˜í–‰í•˜ë©°, ì˜ì¡´ì„±ì€ í•­ìƒ ìƒìœ„ ê³„ì¸µì—ì„œ í•˜ìœ„ ê³„ì¸µìœ¼ë¡œ ë‹¨ë°©í–¥ìœ¼ë¡œ íë¦…ë‹ˆë‹¤.

```
+------------------+      +--------------------+      +--------------------------+
|    API Layer     |----->|   Service Layer    |----->|   Repository Interface   |
|     (app.py)     |      | (Business Logic)   |      |        (Contract)        |
+------------------+      +--------------------+      +--------------------------+
                                                            ^
                                                            | (implements)
                                                            |
+------------------+      +----------------------+      +--------------------------+
| Database (SQLite)|<-----| SQLAlchemy ORM Core  |<-----|  SQLAlchemy Repository   |
+------------------+      +----------------------+      |     (Implementation)     |
                                                            +--------------------------+
```

### 2.1. API Layer (`app.py`)

- **ì—­í• **: HTTP ìš”ì²­ì„ ìˆ˜ì‹ í•˜ê³  ì‘ë‹µì„ ë°˜í™˜í•˜ëŠ” ìµœìƒìœ„ ê³„ì¸µìž…ë‹ˆë‹¤.
- **ì±…ìž„**: ìš”ì²­ íŒŒì‹±, ì¸ì¦, ê¸°ë³¸ ìœ íš¨ì„± ê²€ì‚¬ ë° ì ì ˆí•œ ì„œë¹„ìŠ¤ í˜¸ì¶œì„ ë‹´ë‹¹í•©ë‹ˆë‹¤. ë˜í•œ, ì˜ì¡´ì„± ì£¼ìž…(Dependency Injection)ì˜ ì‹œìž‘ì ìœ¼ë¡œì„œ, ê° ìš”ì²­ì— í•„ìš”í•œ ì„œë¹„ìŠ¤ì™€ ë¦¬í¬ì§€í† ë¦¬ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ê³  ì—°ê²°í•©ë‹ˆë‹¤.

### 2.2. Service Layer (`src/services/`)

- **ì—­í• **: ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
- **ì±…ìž„**: ì—¬ëŸ¬ ë¦¬í¬ì§€í† ë¦¬ë‚˜ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ë“¤ì„ ì¡°í•©í•˜ì—¬ í•˜ë‚˜ì˜ ì™„ì „í•œ ê¸°ëŠ¥ ë‹¨ìœ„ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤. (ì˜ˆ: `ComputeService`ì˜ VM ìƒì„± ë¡œì§)
- **íŠ¹ì§•**: ì´ ê³„ì¸µì€ ë°ì´í„°ë² ì´ìŠ¤ì˜ ì¡´ìž¬ë‚˜ êµ¬í˜„ ê¸°ìˆ (SQLAlchemy ë“±)ì— ëŒ€í•´ ì „í˜€ ì•Œì§€ ëª»í•©ë‹ˆë‹¤. ì˜¤ì§ ë¦¬í¬ì§€í† ë¦¬ **ì¸í„°íŽ˜ì´ìŠ¤**ì—ë§Œ ì˜ì¡´í•©ë‹ˆë‹¤.

### 2.3. Repository Layer (`src/repositories/`)

- **ì—­í• **: ë°ì´í„° ì˜ì†ì„±(Persistence)ì„ ì²˜ë¦¬í•˜ëŠ” ìœ ì¼í•œ ê³„ì¸µìœ¼ë¡œ, ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ì„ ì¶”ìƒí™”í•©ë‹ˆë‹¤.
- **ì±…ìž„**:
    - **Interfaces (`interfaces/`)**: ë°ì´í„° ì ‘ê·¼ì„ ìœ„í•œ ê³„ì•½(Contract)ì„ ì •ì˜í•©ë‹ˆë‹¤. (`IVMRepository` ë“±) ì„œë¹„ìŠ¤ ê³„ì¸µì€ ì´ ì¸í„°íŽ˜ì´ìŠ¤ì—ë§Œ ì˜ì¡´í•©ë‹ˆë‹¤.
    - **Implementations (`sqlalchemy/`)**: ì¸í„°íŽ˜ì´ìŠ¤ì˜ ì‹¤ì œ êµ¬í˜„ë¶€ë¥¼ ìž‘ì„±í•©ë‹ˆë‹¤. SQLAlchemyë¥¼ ì‚¬ìš©í•˜ì—¬ DBì™€ ìƒí˜¸ìž‘ìš©í•˜ëŠ” ëª¨ë“  ì½”ë“œê°€ ì—¬ê¸°ì— í¬í•¨ë©ë‹ˆë‹¤.
- **íŠ¹ì§•**: ë‚˜ì¤‘ì— ë°ì´í„°ë² ì´ìŠ¤ë¥¼ SQLiteì—ì„œ PostgreSQLë¡œ ë°”ê¾¸ê³  ì‹¶ë‹¤ë©´, ì´ êµ¬í˜„ì²´ë§Œ ìƒˆë¡œ ìž‘ì„±í•˜ë©´ ë©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ ê³„ì¸µ ì½”ë“œëŠ” ì „í˜€ ìˆ˜ì •í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

### 2.4. Data Model Layer (`src/database/models/`)

- **ì—­í• **: ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì˜ êµ¬ì¡°ë¥¼ íŒŒì´ì¬ í´ëž˜ìŠ¤ë¡œ ì •ì˜í•©ë‹ˆë‹¤.
- **ì±…ìž„**: SQLAlchemyì˜ ORM ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ í…Œì´ë¸”, ì»¬ëŸ¼, ê´€ê³„ ë“±ì„ ì½”ë“œë¡œ ëª…ì‹œí•©ë‹ˆë‹¤. ì´ ëª¨ë¸ë“¤ì€ ë¦¬í¬ì§€í† ë¦¬ êµ¬í˜„ì²´ì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.

## 3. ðŸ§ ì•„í‚¤í…ì²˜ ê²€í†  ë° ë¹„íŒ

í˜„ìž¬ í”„ë¡œì íŠ¸ì˜ ì•„í‚¤í…ì²˜ë¥¼ ê²€í† í–ˆì„ ë•Œ, í–¥í›„ í™•ìž¥ì„±ì„ ìœ„í•´ ê³ ë ¤í•´ì•¼ í•  ì£¼ìš” ì‚¬í•­ë“¤ìž…ë‹ˆë‹¤.

1.  **ê²¬ê³ ì„± ë¶€ì¡±: ë¡¤ë°±(Rollback) ë¡œì§ ë¶€ìž¬**
    -   **í˜„í™©**: VM ìƒì„± ë˜ëŠ” ì‚­ì œ ê³¼ì • ì¤‘ ì¤‘ê°„ì— ì‹¤íŒ¨í•˜ë©´, ì¼ë¶€ ë¦¬ì†ŒìŠ¤(ë””ìŠ¤í¬ íŒŒì¼, libvirt ì •ì˜ ë“±)ê°€ ê·¸ëŒ€ë¡œ ë‚¨ì•„ ì‹œìŠ¤í…œì— ì“°ë ˆê¸° ë°ì´í„°ê°€ ìŒ“ìž…ë‹ˆë‹¤.
    -   **ìœ„í—˜ì„±**: ì´ëŸ° 'ê³ ì•„ ë¦¬ì†ŒìŠ¤'ë“¤ì€ í–¥í›„ ë‹¤ë¥¸ ìž‘ì—…ì— ì˜ˆê¸°ì¹˜ ì•Šì€ ì¶©ëŒì„ ì¼ìœ¼í‚¬ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
    -   **ê°œì„  ë°©í–¥**: ëª¨ë“  ìž‘ì—… ë‹¨ê³„ë¥¼ íŠ¸ëžœìž­ì…˜(Transaction)ì²˜ëŸ¼ ê´€ë¦¬í•˜ì—¬, ì‹¤íŒ¨ ì‹œ ì´ì „ ìƒíƒœë¡œ ë˜ëŒë¦¬ëŠ” ë¡¤ë°± ë¡œì§ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.

2.  **ì„±ëŠ¥ í•œê³„: ë™ê¸°(Synchronous) ì²˜ë¦¬ ë°©ì‹**
    -   **í˜„í™©**: VM ìƒì„±ì²˜ëŸ¼ ì‹œê°„ì´ ì˜¤ëž˜ ê±¸ë¦¬ëŠ” ìž‘ì—…ì„ ìš”ì²­í•˜ë©´, ì™„ë£Œë  ë•Œê¹Œì§€ APIê°€ ì‘ë‹µì„ ì£¼ì§€ ì•Šê³  ê³„ì† ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
    -   **ìœ„í—˜ì„±**: ì‚¬ìš©ìžê°€ ë§Žì•„ì§€ë©´ ì„œë²„ì˜ ê°€ìš© ìŠ¤ë ˆë“œê°€ ëª¨ë‘ ê³ ê°ˆë˜ì–´ ìƒˆë¡œìš´ ìš”ì²­ì„ ì²˜ë¦¬í•˜ì§€ ëª»í•˜ëŠ” ìƒíƒœê°€ ë  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
    -   **ê°œì„  ë°©í–¥**: ë¡œë“œë§µì— ìžˆë“¯ì´, RabbitMQ ê°™ì€ ë©”ì‹œì§€ íë¥¼ ë„ìž…í•˜ì—¬ ì˜¤ëž˜ ê±¸ë¦¬ëŠ” ìž‘ì—…ì€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¹„ë™ê¸°ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ë„ë¡ êµ¬ì¡°ë¥¼ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.

3.  **ë¹„íš¨ìœ¨ì ì¸ ëª©ë¡ ì¡°íšŒ: N+1 ë¬¸ì œ**
    -   **í˜„í™©**: `list_vms`ëŠ” DBì—ì„œ Nê°œì˜ VMì„ ì¡°íšŒí•œ ë’¤, ê° VMì˜ ìƒíƒœë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ Në²ˆì˜ libvirt APIë¥¼ ì¶”ê°€ë¡œ í˜¸ì¶œí•©ë‹ˆë‹¤.
    -   **ìœ„í—˜ì„±**: VMì˜ ê°œìˆ˜ê°€ ë§Žì•„ì§€ë©´ `GET /v1/vms` APIì˜ ì‘ë‹µ ì†ë„ê°€ ê¸‰ê²©ížˆ ëŠë ¤ì§‘ë‹ˆë‹¤.
    -   **ê°œì„  ë°©í–¥**: `self.conn.listAllDomains()` ê°™ì€ í•¨ìˆ˜ë¡œ libvirtì˜ ëª¨ë“  VM ìƒíƒœë¥¼ **í•œ ë²ˆì—** ê°€ì ¸ì˜¨ í›„, DBì—ì„œ ê°€ì ¸ì˜¨ ì •ë³´ì™€ ë©”ëª¨ë¦¬ìƒì—ì„œ í•©ì¹˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë¦¬íŒ©í† ë§í•˜ì—¬ API í˜¸ì¶œ íšŸìˆ˜ë¥¼ ì¤„ì—¬ì•¼ í•©ë‹ˆë‹¤. (ë¦¬í¬ì§€í† ë¦¬ íŒ¨í„´ ë•ë¶„ì—, ì´ ë¡œì§ì€ `ComputeService`ë¥¼ ìˆ˜ì •í•˜ì§€ ì•Šê³ ë„ ê°œì„ í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.)